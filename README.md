# Rakushift AI - AIシフト管理システム

## プロジェクト概要
Rakushift AI（ラクシフトAI）は、飲食店や小売店向けのシフト管理を効率化するWebアプリケーションです。
管理者は、従業員の希望休、店舗の営業ルール、必要な人員配置要件を設定するだけで、AI（Google Gemini または OpenAI）が最適なシフト表を自動生成します。また、直感的なUIで手動調整も可能です。

## 主な機能

### 1. ダッシュボード
- **本日の状況**: 今日の出勤人数、シフト一覧、進行状況（勤務中/終了など）をリアルタイム表示
- **クイックアクション**: 申請確認、シフト表への移動など、頻繁に使う機能へワンクリックでアクセス
- **人件費分析（管理者のみ）**: 直近の人件費推移をグラフ表示

### 2. シフト管理（Shift Table & Calendar）
- **テーブルビュー (Gantt Chart)**: 
    - **日曜始まり**: 週次表示およびAI自動作成の「翌週」ロジックは、全て日曜日を起点として統一されています。
    - **高解像度ガントチャート**: 1週間表示時に15分単位のグリッドと目盛りを表示し、細かいシフト状況を一目で確認可能に改善
    - **見やすい表示**: 営業時間をハイライトし、シフトバーの視認性を向上
    - **期間切り替え**: 月間 / 2週間 / 1週間 の3モードに対応
    - **過去シフトのグレーアウト**: すでに経過した日程のシフトはグレーアウトされ、視認性が向上しました。
- **カレンダービュー**: 月間カレンダー形式で表示。曜日ごとの配置確認に便利（スクロール対応）
    - **備考・メモ機能**: 日付ごとに「団体予約あり」「大型発注」などのメモを記録・表示できます。
- **AI自動作成**: 
    - 「来週分」や「今月分」を一括生成
    - **過去データの保護**: 分析レポートの整合性を保つため、「リセットして再構築」等の操作を行っても、**本日より前の日付（過去）のシフトは維持され、再生成されません**。
    - **厳格なルール遵守**: スタッフの希望休、勤務日数上限、特定の時間帯の必要人数（`time_staff_req`）を優先
    - **Gemini 1.5 Flash (推奨)** / GPT-4o 対応
- **手動調整**: クリック＆ドラッグ感覚で直感的にシフトを追加・編集・削除

### 3. 店舗設定（Store Settings）
- **基本設定**: 営業時間、定休日
- **役職管理**: 店長、リーダー、スタッフなどの役割とカラー設定
- **シフトパターン**: 「早番」「遅番」などの定型パターン登録
- **人員配置ルール**: 
    - 曜日ごとの最低人数
    - **時間帯別増強**: 「ランチタイム（11:00-14:00）は必ず3人」といった詳細ルール設定
- **休憩ルール**: 勤務時間に応じた休憩時間（例: 6時間超で45分）の自動適用

### 4. スタッフ管理（Staff Management）
- **プロフィール**: 名前、役職、給与形態（時給/月給）
- **勤務制約**: 週の最大勤務日数、1日の最大勤務時間
- **除外日**: 絶対に出勤できない日の管理

### 5. 休暇・シフト申請（Requests）
- スタッフからの「希望休」「勤務希望」を管理
- 承認すると自動的にシフト表や除外日リストに反映

## 技術スタック
- **Frontend**: HTML5, CSS3 (Tailwind CSS via CDN), JavaScript (Vanilla ES6+)
- **Charts**: Chart.js (CDN)
- **Icons**: Font Awesome (CDN)
- **Data Persistence**: RESTful Table API (Internal Tool)
- **AI Integration**: Google Gemini API / OpenAI API (Client-side fetch)

## 最新のアップデート (2026-01-07)

### ✅ 二段階ログイン機能の実装（店舗共有→管理者認証）
- **第一段階：店舗ログイン**: 全スタッフが共有する「契約ID」と「店舗パスワード」でまずログインします。この状態ではシフト表の閲覧のみが可能です。
- **第二段階：管理者認証**: 画面内の「管理者ログイン」ボタンから、個人の管理者IDとパスワードを入力することで、シフト編集や設定などの管理者機能が有効になります。
- **セキュリティと利便性の両立**: 共用タブレット等での運用を想定し、普段は閲覧モードで置いておき、必要な時だけ店長がログインして操作するフローを実現しました。

### 🛠️ SaaS構成 (Production Architecture)

本システムは、マルチテナントSaaSとして設計されており、以下の構成で動作します。

```mermaid
graph TD
    User[ユーザー (ブラウザ)] -->|Frontend Logic| Static[Static Web App (js/html/css)]
    Static -->|REST API| Supabase[Supabase (Database & Auth)]
    
    subgraph "Shift Generation Flow"
        Static -->|1. Optimization Request| PyServer[Cloud Run (Python Optimization)]
        PyServer -->|2. Draft Shifts| Static
        Static -->|3. Audit Request| Gemini[Gemini API (Audit & Fix)]
        Gemini -->|4. Final Shifts| Static
    end

    Static -->|Save Data| Supabase
```

1.  **データ永続化 (Supabase)**: `staff`, `shifts`, `config` などの全データはSupabaseで一元管理されます。RLS (Row Level Security) により、組織間のデータ分離が保証されます。
2.  **数理最適化 (Cloud Run)**: 複雑なシフト計算は、スケーラブルなPythonサーバーで行います。
3.  **AI監査 (Gemini API)**: 計算結果を最新のLLMがダブルチェックし、人間的な制約やニュアンスを調整します。

### ✅ シフト自動生成エンジンの刷新
- **Python最適化エンジン**: サーバーサイドで厳密な数理最適化計算を実行。
- **Gemini監査**: 生成されたシフトをAIがレビューし、制約違反を修正する二段構えの構成。
- **4段階評価対応**: スタッフ評価をA〜Dの4段階に拡張し、Aランクのスタッフを優先的に割り当てるようにしました。
- **勤務制約の遵守**:
  - **社員（月給）**: 月間労働時間（約160〜177時間）を考慮し、週5日勤務をベースに優先配置します。
  - **アルバイト**: 各自の「週最大勤務日数」「1日の最大時間」設定を遵守し、希望休を避けて配置します。

### 🔑 デモアカウント情報
以下の情報でログインしてシステムをお試しいただけます。

#### 1. 店舗ログイン（全員共通）
| 項目 | 値 |
| :--- | :--- |
| **契約ID (Contract ID)** | `demo` |
| **店舗パスワード** | `demo` |

#### 2. 管理者ログイン（機能編集用）
| 項目 | 値 |
| :--- | :--- |
| **管理者ID** | `admin` |
| **パスワード** | `password` |

## 最新のアップデート (2025-12-19)

### ✅ 機能追加・改善
1.  **カレンダービューへの備考（メモ）機能追加**:
    - 日付ごとに「団体予約」や「大型発注」などのメモを追加できるようになりました。
    - カレンダーセル上に黄色い付箋スタイルで表示され、マウスオーバーで詳細を確認できます。
2.  **過去シフトの視覚的区別**:
    - シフト表およびカレンダービューにおいて、昨日以前（過去）のシフトや日付セルをグレーアウト表示にし、現在・未来のシフトと明確に区別できるようにしました。
    - ※あくまで見た目の変更のみで、分析データの数値には影響しません。

### ✅ 分析レポート保護のための機能変更
1.  **AI自動作成時の過去日保護**:
    - ユーザーからの要望に基づき、「AI自動作成」および「リセット」機能の挙動を変更しました。
    - 分析レポート（人件費・労働時間の実績）への影響を防ぐため、**本日（操作日）より前の日付のシフトデータは、いかなる場合も削除・再生成されません**。
    - 「リセットして再構築」を選択した場合でも、リセット（削除）およびAI生成の対象となるのは「本日以降」のシフトのみとなります。
2.  **週次計算の日曜日統一**:
    - 「来週のシフトを作成」等の自動生成ロジックにおいて、週の開始日を明確に「日曜日」に統一しました。

## 今後の予定
- シフト表のPDFエクスポート機能の強化
- スタッフ向けスマホ専用ビューの最適化
- 通知機能の実装

## 公開URL
- **Production**: (System generated URL)
- **API Endpoint**: `tables/{table_name}`
